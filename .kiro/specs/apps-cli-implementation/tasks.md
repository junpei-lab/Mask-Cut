# Implementation Plan

- [x] 1. CLI シェルの土台を整備する

  - 引数解析と実行環境初期化を担当するエントリーポイントを整理し、コマンドルータへ責務を集約する。
  - 共通の実行コンテキスト（quiet/dry-run/log ファイル指定など）を生成し、後続ハンドラが再利用できるようにする。
  - 想定コマンドのメタデータを宣言し、ヘルプ出力とバリデーション方針を定義する。
  - _Requirements: 1, 3_

- [x] 1.1 コマンドルータとハンドラインターフェースを構築する

  - サブコマンド識別・引数検証・エラー伝播を統一管理するルーティング層を実装する。
  - ハンドラ登録とディスパッチの仕組みを用意し、将来のコマンド追加に備える。
  - _Requirements: 1, 3_

- [x] 2. マスキング実行コマンドを実装する

  - 入力ソース解決、オプション適用、LLM 呼び出し、結果整形までのワークフローを組み立てる。
  - 実行開始時と終了時に処理メタデータを集計し、後続の監査ログ出力に渡す。
  - _Requirements: 1_

- [x] 2.1 入力解決ロジックを拡張する

  - `--text`指定・ファイル参照・標準入力・対話モードを検出し、テキストと付随情報を正規化する。
  - 大きな入力でもメモリ効率が落ちないようストリーム読込やバッファ処理を設計する。
  - マスキング対象が未指定のときはヘルプを提示し、ガイド付きで終了する。
  - _Requirements: 1.1, 1.2, 1.5_

- [x] 2.2 マスキングオプション適用と LLM 呼び出しを統合する

  - スタイル・長さ維持・言語・曖昧名詞マスク設定をコアライブラリの入力形式へ変換する。
  - プロファイル設定と CLI 指定の競合を解決し、最終オプションを決定する。
  - LLM 応答が空や不正な場合にユースケース違反として扱うガードを追加する。
  - _Requirements: 1.3, 1.4, 4.3_

- [x] 3. 設定管理と認証保護を実装する

  - プロファイル単位でエンドポイント・モデル・ログ設定を保存するサービス層を用意する。
  - 初期セットアップとスキーマバージョン管理を行い、欠損時に安全なデフォルトを提供する。
  - _Requirements: 2_

- [x] 3.1 シークレット保管と検証フローを整備する

  - API キー等の機微情報を OS キーリングに保存・取得し、非対応環境では暗号化ファイルへフォールバックする。
  - `config set`実行時に入力値を検証し、保存失敗時は復旧手順を案内する。
  - 設定表示時には機微情報をマスクしつつ更新日時や利用中プロファイルを明示する。
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 3.2 プロファイル解決と切替ロジックを実装する

  - 既定プロファイルと明示指定プロファイルの優先順位を定義し、存在しない場合はエラーとする。
  - 複数プロファイル環境での一覧表示と選択操作を実装する。
  - _Requirements: 2.5_

- [x] 4. 出力制御とエラーハンドリングを強化する

  - JSON/テキスト出力、静粛モード、ドライランを切り替えるフォーマッタを実装する。
  - 終了コード規約を確立し、CLI エントリでプロセスコードと標準出力/標準エラーの制御を行う。
  - _Requirements: 3_

- [x] 4.1 監査ログと診断情報の記録機構を実装する

  - 実行開始・終了時刻、入力/出力バイト数、プロファイル名、結果ステータスを構造化ログに追記する。
  - `--log-file`指定がある場合は追記モードで安全に書き込み、存在しないディレクトリを自動作成する。
  - _Requirements: 3.5, 4.4, 4.5_

- [x] 4.2 エラー分類とユーザー向けメッセージガイドを整備する

  - タイムアウト・ネットワーク・設定不足などの例外を分類し、再実行手順や復旧策を添えて提示する。
  - CLI が再試行すべきでない条件を明確にし、早期に失敗を通知する。
  - _Requirements: 3.2, 4.1, 4.2, 4.3_

- [x] 5. テストと検証を整備する
  - マスキングハンドラ・設定サービス・フォーマッタなど主要コンポーネントの単体テストを追加する。
  - CLI 統合テストで標準入力パイプ・ドライラン・静粛モード・エラー終了を検証する。
  - _Requirements: 1, 2, 3, 4_
